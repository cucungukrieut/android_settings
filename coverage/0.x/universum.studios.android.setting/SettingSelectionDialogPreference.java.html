<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SettingSelectionDialogPreference.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">universum.studios.android.setting</a> &gt; <span class="el_source">SettingSelectionDialogPreference.java</span></div><h1>SettingSelectionDialogPreference.java</h1><pre class="source lang-java linenums">/*
 * =================================================================================================
 *                             Copyright (C) 2017 Universum Studios
 * =================================================================================================
 *         Licensed under the Apache License, Version 2.0 or later (further &quot;License&quot; only).
 * -------------------------------------------------------------------------------------------------
 * You may use this file only in compliance with the License. More details and copy of this License 
 * you may obtain at
 * 
 * 		http://www.apache.org/licenses/LICENSE-2.0
 * 
 * You can redistribute, modify or publish any part of the code written within this file but as it 
 * is described in the License, the software distributed under the License is distributed on an 
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES or CONDITIONS OF ANY KIND.
 * 
 * See the License for the specific language governing permissions and limitations under the License.
 * =================================================================================================
 */
package universum.studios.android.setting;

import android.annotation.TargetApi;
import android.content.Context;
import android.content.res.Resources;
import android.content.res.TypedArray;
import android.os.Build;
import android.support.annotation.ArrayRes;
import android.support.annotation.AttrRes;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.support.annotation.StyleRes;
import android.util.AttributeSet;
import android.view.View;

import org.json.JSONArray;
import org.json.JSONException;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import universum.studios.android.dialog.Dialog;
import universum.studios.android.dialog.SelectionDialog;
import universum.studios.android.dialog.adapter.DialogSelectionAdapter;

/**
 * A {@link SettingDialogPreference} implementation that may be used to allow to a user to select
 * its preferred values, either in &lt;b&gt;single&lt;/b&gt; or &lt;b&gt;multiple&lt;/b&gt; choice mode, for a specific
 * setting preference. Entries that should be available for selection may be specified via
 * {@link #setEntries(CharSequence[])} along with theirs corresponding entry values that should be
 * specified via {@link #setEntryValues(CharSequence[])}.
 * &lt;p&gt;
 * This preference implementation by default displays the preferred entry values as its summary text,
 * using {@link SummaryTextBuilder}, that may be specified via {@link #setSummaryTextBuilder(SummaryTextBuilder)},
 * to build the summary text from the selected entry values. If there are no preferred entry values
 * selected yet, the standard summary text is displayed. The selected entry values are persisted as
 * {@link String} in Json Array format. The preferred entry values may be specified via {@link #setSelection(long[])}
 * where the passed array should contain indexes of entry values specified via {@link #setEntryValues(CharSequence[])}
 * to be persisted. The current selection array may be obtained via {@link #getSelection()}. Array
 * of persisted entry values may be obtained via {@link #getSelecedEntryValues()}. Outside of context
 * of the selection preference it may be obtained via {@link #selectedEntryValuesFromPersistedValues(String)}
 * method which accepts {@link String} containing persisted entry values in Json Array format.
 * &lt;p&gt;
 * When {@link #handleOnDialogButtonClick(Dialog, int)} is called, this preference implementation
 * handles only {@link SelectionDialog} type of dialog. If its {@link Dialog#BUTTON_POSITIVE} button
 * has been clicked, the selection array provided via {@link SelectionDialog#getSelection()} is set
 * as selection for this preference via {@link #setSelection(long[])}.
 *
 * &lt;h3&gt;Default value&lt;/h3&gt;
 * Default value for this preference is parsed as {@link String} which should contain entry values
 * that should be by default selected, in Json Array format like {@code &quot;[&quot;entry_value_1&quot;, &quot;entry_value_2&quot;]&quot;}.
 * See {@link TypedArray#getString(int)}.
 *
 * &lt;h3&gt;Xml attributes&lt;/h3&gt;
 * See {@link SettingDialogPreference},
 * {@link R.styleable#Ui_Settings_SelectionDialogPreference SettingSelectionDialogPreference Attributes}
 *
 * &lt;h3&gt;Default style attribute&lt;/h3&gt;
 * {@link R.attr#uiSettingSelectionDialogPreferenceStyle uiSettingSelectionDialogPreferenceStyle}
 *
 * @author Martin Albedinsky
 */
public class SettingSelectionDialogPreference extends SettingDialogPreference&lt;SelectionDialog.SelectionOptions&gt; {

	/*
	 * Constants ===================================================================================
	 */

	/**
	 * Log TAG.
	 */
	// private static final String TAG = &quot;SettingSelectionDialogPreference&quot;;

	/**
	 * Default separator for entry items presented in the summary text.
	 */
	private static final String SUMMARY_ENTRIES_SEPARATOR = &quot;, &quot;;

	/*
	 * Interface ===================================================================================
	 */

	/**
	 * Interface for builder that is used by {@link SettingSelectionDialogPreference} to build its
	 * summary text from the current selection of entry items.
	 *
	 * @author Martin Albedinsky
	 * @see #setSummaryTextBuilder(SummaryTextBuilder)
	 */
	public interface SummaryTextBuilder {

		/**
		 * Clears the current content of this builder.
		 * &lt;p&gt;
		 * This is called by the associated selection preference whenever a new summary text is about
		 * to be build.
		 *
		 * @return This builder to allow methods chaining.
		 */
		SummaryTextBuilder clear();

		/**
		 * Appends the given &lt;var&gt;entry&lt;/var&gt; into content of this builder. If this builder uses
		 * separator to separate multiple entries, such separator will be included accordingly.
		 * &lt;p&gt;
		 * This is called by the associated selection preference for each selected entry.
		 *
		 * @param entry The entry to be appended.
		 * @return This builder to allow methods chaining.
		 */
		SummaryTextBuilder appendEntry(@NonNull CharSequence entry);

		/**
		 * Builds summary text from the current content (entries) appended into this builder.
		 * &lt;p&gt;
		 * This is called by the associated selection preference when all currently selected entries
		 * have been appended into this builder.
		 *
		 * @return Summary text with entries.
		 */
		@NonNull
		CharSequence build();
	}

	/*
	 * Static members ==============================================================================
	 */

	/*
	 * Members =====================================================================================
	 */

	/**
	 * Array containing entries from which are created {@link #mDialogItems} to be displayed in the
	 * selection dialog.
	 */
	private CharSequence[] mEntries;

	/**
	 * Array containing values where each value is associated with one entry item. Value for the
	 * associated selected entry is persisted in the preferences.
	 */
	private CharSequence[] mEntryValues;

	/**
	 * Boolean flag indicating whether the selection value for this preference has been set or not.
	 * This flag is used to handle case when the same value is being specified for this preference,
	 * but for the first time, to properly refresh view of this preference and notify listeners about
	 * the change.
	 */
	private boolean mSelectionSet;

	/**
	 * Current selection value specified for this preference. This may be either value specified by
	 * the user, default value or persisted value.
	 * &lt;p&gt;
	 * Note, that this selection contains indexes of the preferred entry values from the {@link #mEntryValues}
	 * array. The selection is created from the persisted Json array containing selected entry values
	 * via {@link #createSelectionFromPersistedValues(String)} or transformed into persistable Json
	 * array of entry values via {@link #createPersistableValuesFromSelection(long[])} and persisted
	 * as {@link String} via {@link #persistString(String)}.
	 */
	private long[] mSelection;

	/**
	 * List containing selectable items converted from array of {@link #mEntries} to be displayed in
	 * the selection dialog.
	 */
	private List&lt;DialogSelectionAdapter.Item&gt; mDialogItems;

	/**
	 * Builder that is used to build a summary text for the current selected items.
	 */
	private SummaryTextBuilder mSummaryTextBuilder;

	/*
	 * Constructors ================================================================================
	 */

	/**
	 * Same as {@link #SettingSelectionDialogPreference(Context, AttributeSet)} without attributes.
	 */
	public SettingSelectionDialogPreference(@NonNull final Context context) {
<span class="nc" id="L203">		this(context, null);</span>
<span class="nc" id="L204">	}</span>

	/**
	 * Same as {@link #SettingSelectionDialogPreference(Context, AttributeSet, int)} with
	 * {@link R.attr#uiSettingSelectionDialogPreferenceStyle} as attribute for default style.
	 */
	public SettingSelectionDialogPreference(@NonNull final Context context, @Nullable AttributeSet attrs) {
<span class="nc" id="L211">		this(context, attrs, R.attr.uiSettingSelectionDialogPreferenceStyle);</span>
<span class="nc" id="L212">	}</span>

	/**
	 * Same as {@link #SettingSelectionDialogPreference(Context, AttributeSet, int, int)} with {@code 0}
	 * as default style.
	 */
	public SettingSelectionDialogPreference(@NonNull final Context context, @Nullable final AttributeSet attrs, @AttrRes final int defStyleAttr) {
<span class="nc" id="L219">		super(context, attrs, defStyleAttr);</span>
<span class="nc" id="L220">		this.init(context, attrs, defStyleAttr, 0);</span>
<span class="nc" id="L221">	}</span>

	/**
	 * Creates a new instance of SettingSelectionDialogPreference for the given &lt;var&gt;context&lt;/var&gt;.
	 *
	 * @param context      Context in which will be the new setting preference presented.
	 * @param attrs        Set of Xml attributes used to configure the new instance of this preference.
	 * @param defStyleAttr An attribute which contains a reference to a default style resource for
	 *                     this preference within a theme of the given context.
	 * @param defStyleRes  Resource id of the default style for the new preference.
	 */
	@TargetApi(Build.VERSION_CODES.LOLLIPOP)
	public SettingSelectionDialogPreference(@NonNull final Context context, @Nullable final AttributeSet attrs, @AttrRes final int defStyleAttr, @StyleRes final int defStyleRes) {
<span class="nc" id="L234">		super(context, attrs, defStyleAttr, defStyleRes);</span>
<span class="nc" id="L235">		this.init(context, attrs, defStyleAttr, defStyleRes);</span>
<span class="nc" id="L236">	}</span>

	/*
	 * Methods =====================================================================================
	 */

	/**
	 * Called from one of constructors of this setting preference to perform its initialization.
	 * &lt;p&gt;
	 * Initialization is done via parsing of the specified &lt;var&gt;attrs&lt;/var&gt; set and obtaining for
	 * this preference specific data from it that can be used to configure this new preference instance.
	 * The specified &lt;var&gt;defStyleAttr&lt;/var&gt; and &lt;var&gt;defStyleRes&lt;/var&gt; are used to obtain default
	 * data from the current theme provided by the specified &lt;var&gt;context&lt;/var&gt;.
	 */
	private void init(final Context context, final AttributeSet attrs, final int defStyleAttr, final int defStyleRes) {
<span class="nc" id="L251">		final TypedArray attributes = context.obtainStyledAttributes(attrs, R.styleable.Ui_Settings_SelectionDialogPreference, defStyleAttr, defStyleRes);</span>
<span class="nc" id="L252">		setEntries(attributes.getTextArray(R.styleable.Ui_Settings_SelectionDialogPreference_android_entries));</span>
<span class="nc" id="L253">		setEntryValues(attributes.getTextArray(R.styleable.Ui_Settings_SelectionDialogPreference_android_entryValues));</span>
<span class="nc" id="L254">		attributes.recycle();</span>
<span class="nc" id="L255">		this.mSummaryTextBuilder = new DefaultSummaryTextBuilder(SUMMARY_ENTRIES_SEPARATOR);</span>
<span class="nc" id="L256">	}</span>

	/**
	 */
	@NonNull
	@Override
	protected SelectionDialog.SelectionOptions onCreateDialogOptions(@NonNull Resources resources) {
<span class="nc" id="L263">		return new SelectionDialog.SelectionOptions(resources)</span>
<span class="nc" id="L264">				.title(getTitle())</span>
<span class="nc" id="L265">				.selectionMode(DialogSelectionAdapter.SINGLE)</span>
<span class="nc" id="L266">				.emptySelectionAllowed(true);</span>
	}

	/**
	 */
	@Override
	@SuppressWarnings(&quot;ResourceType&quot;)
	protected void onConfigureDialogOptions(
			@NonNull final SelectionDialog.SelectionOptions options,
			@NonNull final Context context,
			@Nullable final AttributeSet attrs,
			@AttrRes final int defStyleAttr,
			@StyleRes final int defStyleRes
	) {
<span class="nc" id="L280">		super.onConfigureDialogOptions(options, context, attrs, defStyleAttr, defStyleRes);</span>
<span class="nc" id="L281">		final TypedArray attributes = context.obtainStyledAttributes(attrs, R.styleable.Ui_Settings_SelectionDialogPreference, defStyleAttr, defStyleRes);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">		for (int i = 0; i &lt; attributes.getIndexCount(); i++) {</span>
<span class="nc" id="L283">			final int index = attributes.getIndex(i);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">			if (index == R.styleable.Ui_Settings_SelectionDialogPreference_dialogSelectionMode) {</span>
<span class="nc" id="L285">				options.selectionMode(attributes.getInt(index, options.selectionMode()));</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">			} else if (index == R.styleable.Ui_Settings_SelectionDialogPreference_dialogEmptySelectionAllowed) {</span>
<span class="nc" id="L287">				options.emptySelectionAllowed(attributes.getBoolean(index, options.shouldAllowEmptySelection()));</span>
			}
		}
<span class="nc" id="L290">		attributes.recycle();</span>
<span class="nc" id="L291">	}</span>

	/**
	 * Same as {@link #setEntries(CharSequence[])} for resource id.
	 *
	 * @param resId Resource id of the desired text array with entries.
	 */
	public void setEntries(@ArrayRes final int resId) {
<span class="nc" id="L299">		setEntries(getContext().getResources().getTextArray(resId));</span>
<span class="nc" id="L300">	}</span>

	/**
	 * Specifies an array of entries that should be displayed in the associated selection dialog.
	 *
	 * @param entries The desired array of entries. May be {@code null} to clear the current ones.
	 * @see android.R.attr#entries
	 * @see #setEntryValues(CharSequence[])
	 */
	public void setEntries(@Nullable final CharSequence[] entries) {
<span class="nc" id="L310">		this.mEntries = entries;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		if (entries == null) {</span>
<span class="nc" id="L312">			this.mDialogItems = null;</span>
		} else {
<span class="nc" id="L314">			this.mDialogItems = new ArrayList&lt;&gt;(entries.length);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">			for (int i = 0; i &lt; entries.length; i++) {</span>
<span class="nc" id="L316">				final CharSequence entry = entries[i];</span>
<span class="nc" id="L317">				mDialogItems.add(new SelectionDialog.TextItem(i, entry));</span>
			}
		}
<span class="nc" id="L320">	}</span>

	/**
	 * Returns the array of entries specified for this preference.
	 *
	 * @return Array with entries. May be {@code null} if no entries have been specified.
	 * @see #setEntries(CharSequence[])
	 * @see #getEntryValues()
	 */
	@Nullable
	public CharSequence[] getEntries() {
<span class="nc" id="L331">		return mEntries;</span>
	}

	/**
	 * Same as {@link #setEntryValues(CharSequence[])} for resource id.
	 *
	 * @param resId Resource id of the desired text array with values for entries.
	 */
	public void setEntryValues(@ArrayRes final int resId) {
<span class="nc" id="L340">		setEntryValues(getContext().getResources().getTextArray(resId));</span>
<span class="nc" id="L341">	}</span>

	/**
	 * Specifies an array of entry values where each value should be associated with corresponding
	 * entry from the entries array specified via {@link #setEntries(CharSequence[])}.
	 * &lt;p&gt;
	 * &lt;b&gt;Note&lt;/b&gt;, that this method does not check if the entries and entry values arrays are
	 * consistent, that is that they are equal in length.
	 *
	 * @param entryValues The desired array of values associated with entries. May be {@code null}
	 *                    to clear the current ones.
	 * @see android.R.attr#entryValues
	 */
	public void setEntryValues(@Nullable final CharSequence[] entryValues) {
<span class="nc" id="L355">		this.mEntryValues = entryValues;</span>
<span class="nc" id="L356">	}</span>

	/**
	 * Returns the array of entry values associated with the entries specified for this preference.
	 *
	 * @return Array with entry values. May be {@code null} if no entry values have been specified.
	 * @see #setEntryValues(CharSequence[])
	 * @see #getEntries()
	 */
	@Nullable
	public CharSequence[] getEntryValues() {
<span class="nc" id="L367">		return mEntryValues;</span>
	}

	/**
	 * Sets a builder that should be used by this preference to build its summary text for the current
	 * selected entry items.
	 * &lt;p&gt;
	 * By default, this preference uses internal implementation of the summary builder which
	 * separates the entry items in the summary text by ', '.
	 *
	 * @param textBuilder The desired builder for the summary text. May be {@code null} to use the
	 *                    default one.
	 */
	public void setSummaryTextBuilder(@Nullable final SummaryTextBuilder textBuilder) {
<span class="nc bnc" id="L381" title="All 2 branches missed.">		this.mSummaryTextBuilder = textBuilder == null ? new DefaultSummaryTextBuilder(SUMMARY_ENTRIES_SEPARATOR) : textBuilder;</span>
<span class="nc" id="L382">	}</span>

	/**
	 */
	@Override
	protected Object onGetDefaultValue(@NonNull final TypedArray typedArray, final int index) {
<span class="nc" id="L388">		return typedArray.getText(index);</span>
	}

	/**
	 */
	@Override
	protected void onSetInitialValue(final boolean restorePersistedValue, @Nullable final Object defaultValue) {
<span class="nc bnc" id="L395" title="All 2 branches missed.">		if (restorePersistedValue) {</span>
<span class="nc" id="L396">			final String persistedValues = getPersistedString(null);</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">			setSelection(persistedValues == null ? mSelection : createSelectionFromPersistedValues(persistedValues));</span>
<span class="nc" id="L398">		} else {</span>
<span class="nc" id="L399">			setSelection(createSelectionFromPersistedValues((String) defaultValue));</span>
		}
<span class="nc" id="L401">	}</span>

	/**
	 * Creates an array of selected entry values from the given &lt;var&gt;persistedValues&lt;/var&gt; String.
	 *
	 * @param persistedValues The string with entry values in Json Array format persisted for a
	 *                        particular {@link SettingSelectionDialogPreference}.
	 * @return Array of entry values that have been persisted or {@code null} if no preferred values
	 * have been selected/persisted yet.
	 */
	@Nullable
	public static String[] selectedEntryValuesFromPersistedValues(@NonNull final String persistedValues) {
		try {
<span class="nc" id="L414">			final JSONArray persistedArray = new JSONArray(persistedValues);</span>
<span class="nc" id="L415">			final String[] selectedValues = new String[persistedArray.length()];</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">			for (int i = 0; i &lt; persistedArray.length(); i++) {</span>
<span class="nc" id="L417">				selectedValues[i] = persistedArray.getString(i);</span>
			}
<span class="nc" id="L419">			return selectedValues;</span>
<span class="nc" id="L420">		} catch (JSONException e) {</span>
<span class="nc" id="L421">			e.printStackTrace();</span>
		}
<span class="nc" id="L423">		return null;</span>
	}

	/**
	 * Creates the selection array for this preference from the given &lt;var&gt;persistedValues&lt;/var&gt;.
	 *
	 * @param persistedValues The persisted selection values, created via {@link #createPersistableValuesFromSelection(long[])}.
	 * @return Selection array containing indexes of the selected entries.
	 */
	private long[] createSelectionFromPersistedValues(final String persistedValues) {
		try {
<span class="nc" id="L434">			final JSONArray persistedArray = new JSONArray(persistedValues);</span>
<span class="nc" id="L435">			final long[] selection = new long[persistedArray.length()];</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">			for (int i = 0; i &lt; persistedArray.length(); i++) {</span>
<span class="nc" id="L437">				final String selectedValue = persistedArray.getString(i);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">				for (int j = 0; j &lt; mEntryValues.length; j++) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">					if (mEntryValues[j].equals(selectedValue)) {</span>
<span class="nc" id="L440">						selection[i] = j;</span>
<span class="nc" id="L441">						break;</span>
					}
				}
			}
<span class="nc" id="L445">			return selection;</span>
<span class="nc" id="L446">		} catch (JSONException e) {</span>
<span class="nc" id="L447">			e.printStackTrace();</span>
		}
<span class="nc" id="L449">		return null;</span>
	}

	/**
	 * Creates the persistable values string from the given &lt;var&gt;selection&lt;/var&gt; array.
	 *
	 * @param selection The selection to be transformed into persistable values string.
	 * @return String containing array of entry values according to the specified selection in the
	 * Json Array format.
	 */
	private String createPersistableValuesFromSelection(final long[] selection) {
<span class="nc" id="L460">		final JSONArray persistableArray = new JSONArray();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">		for (final long itemIndex : selection) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">			if (((int) itemIndex) &lt; mEntryValues.length) {</span>
<span class="nc" id="L463">				persistableArray.put(mEntryValues[(int) itemIndex]);</span>
			}
		}
<span class="nc" id="L466">		return persistableArray.toString();</span>
	}

	/**
	 * Sets a selection array containing indexes of preferred entry values that have been specified
	 * via {@link #setEntryValues(CharSequence[])} for this preference.
	 *
	 * @param selection The desired selection array with indexes of the preferred entry values to
	 *                  be persisted as {@link String} in Json Array format.
	 * @see #getSelection()
	 */
	public void setSelection(@Nullable final long[] selection) {
<span class="nc bnc" id="L478" title="All 2 branches missed.">		final boolean changed = !Arrays.equals(mSelection, selection);</span>
<span class="nc" id="L479">		final String selectionValues = createPersistableValuesFromSelection(selection);</span>
<span class="nc bnc" id="L480" title="All 6 branches missed.">		if (callChangeListener(selectionValues) &amp;&amp; (changed || !mSelectionSet)) {</span>
<span class="nc" id="L481">			this.mSelection = selection;</span>
<span class="nc" id="L482">			this.mSelectionSet = true;</span>
<span class="nc" id="L483">			persistString(selectionValues);</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">			if (changed) {</span>
<span class="nc" id="L485">				notifyChanged();</span>
			}
		}
<span class="nc" id="L488">	}</span>

	/**
	 * Returns the array of indexes of the preferred entry values of this preference.
	 *
	 * @return Selection array either specified by the user, as default value or the persisted one.
	 * @see #setSelection(long[])
	 * @see #getSelecedEntryValues()
	 * @see #getDialogOptions()
	 */
	@Nullable
	public long[] getSelection() {
<span class="nc" id="L500">		return mSelection;</span>
	}

	/**
	 * Returns the array of preferred entry values of this preference.
	 *
	 * @return Array containing entry values that have been selected either by user, as default value
	 * or the persisted one.
	 * @see #getSelection()
	 */
	@Nullable
	public CharSequence[] getSelecedEntryValues() {
<span class="nc bnc" id="L512" title="All 2 branches missed.">		if (mSelectionSet) {</span>
<span class="nc" id="L513">			final CharSequence[] selectedValues = new CharSequence[mSelection.length];</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">			for (int i = 0; i &lt; mSelection.length; i++) {</span>
<span class="nc" id="L515">				selectedValues[i] = mEntryValues[(int) mSelection[i]];</span>
			}
<span class="nc" id="L517">			return selectedValues;</span>
		}
<span class="nc" id="L519">		return null;</span>
	}

	/**
	 */
	@Override
	public void onBindView(@NonNull final View view) {
<span class="nc" id="L526">		super.onBindView(view);</span>
<span class="nc" id="L527">		synchronizeSummaryView(view);</span>
<span class="nc" id="L528">	}</span>

	/**
	 */
	@Nullable
	@Override
	protected CharSequence onGetSummaryText() {
<span class="nc bnc" id="L535" title="All 4 branches missed.">		if (mSelectionSet &amp;&amp; mSelection.length &gt; 0) {</span>
<span class="nc" id="L536">			mSummaryTextBuilder.clear();</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">			for (final long itemIndex : mSelection) {</span>
<span class="nc" id="L538">				mSummaryTextBuilder.appendEntry(mEntries[(int) itemIndex]);</span>
			}
<span class="nc" id="L540">			return mSummaryTextBuilder.build();</span>
		}
<span class="nc" id="L542">		return super.onGetSummaryText();</span>
	}

	/**
	 */
	@NonNull
	@Override
	public SelectionDialog.SelectionOptions getDialogOptions() {
<span class="nc" id="L550">		final SelectionDialog.SelectionOptions options = super.getDialogOptions();</span>
<span class="nc" id="L551">		options.items(mDialogItems);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">		if (mSelectionSet) {</span>
<span class="nc" id="L553">			options.selection(mSelection);</span>
		}
<span class="nc" id="L555">		return options;</span>
	}

	/**
	 */
	@Override
	protected boolean onHandleDialogButtonClick(@NonNull final Dialog dialog, @Dialog.Button final int button) {
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (dialog instanceof SelectionDialog) {</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">			switch (button) {</span>
				case Dialog.BUTTON_POSITIVE:
<span class="nc" id="L565">					setSelection(((SelectionDialog) dialog).getSelection());</span>
<span class="nc" id="L566">					return true;</span>
				default:
<span class="nc" id="L568">					return true;</span>
			}
		}
<span class="nc" id="L571">		return super.onHandleDialogButtonClick(dialog, button);</span>
	}

	/*
	 * Inner classes ===============================================================================
	 */

	/**
	 * A {@link SummaryTextBuilder} implementation that is used as default builder by the selection
	 * preference.
	 */
	private static final class DefaultSummaryTextBuilder implements SummaryTextBuilder {

		/**
		 * String builder used when building the summary text.
		 */
		private final StringBuilder builder;

		/**
		 * Separator used to separate entry items.
		 */
		private final String separator;

		/**
		 * Creates a new instance of DefaultSummaryTextBuilder with the specified &lt;var&gt;separator&lt;/var&gt;.
		 *
		 * @param separator The desired separator used to separate entry items.
		 */
<span class="nc" id="L599">		DefaultSummaryTextBuilder(@NonNull final String separator) {</span>
<span class="nc" id="L600">			this.builder = new StringBuilder(64);</span>
<span class="nc" id="L601">			this.separator = separator;</span>
<span class="nc" id="L602">		}</span>

		/**
		 */
		@Override
		public SummaryTextBuilder clear() {
<span class="nc" id="L608">			builder.setLength(0);</span>
<span class="nc" id="L609">			return this;</span>
		}

		/**
		 */
		@Override
		public SummaryTextBuilder appendEntry(@NonNull final CharSequence entry) {
<span class="nc bnc" id="L616" title="All 2 branches missed.">			if (builder.length() &gt; 0) {</span>
<span class="nc" id="L617">				builder.append(separator);</span>
			}
<span class="nc" id="L619">			builder.append(entry);</span>
<span class="nc" id="L620">			return this;</span>
		}

		/**
		 */
		@NonNull
		@Override
		public CharSequence build() {
<span class="nc" id="L628">			return builder.toString();</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span>Generated by the Android Gradle plugin 2.3.1</div></body></html>